<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chatlog</title>
		<style>
			:root {
				--primary-color: #3498db;
				--primary-dark: #2980b9;
				--success-color: #2ecc71;
				--success-dark: #27ae60;
				--error-color: #e74c3c;
				--bg-light: #f5f5f5;
				--bg-white: #ffffff;
				--text-color: #333333;
				--border-color: #dddddd;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
					"Helvetica Neue", sans-serif;
				line-height: 1.6;
				color: var(--text-color);
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
				background-color: #fafafa;
			}

			.container {
				display: flex;
				flex-direction: column;
				align-items: center;
				width: 100%;
			}

			.welcome-text {
				text-align: center;
				margin-bottom: 30px;
			}

			.api-section {
				background-color: var(--bg-light);
				border-radius: 10px;
				padding: 25px;
				width: 100%;
				max-width: 850px;
				margin-bottom: 30px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
			}

			h1 {
				color: #2c3e50;
				margin-bottom: 15px;
			}

			h2 {
				color: var(--primary-color);
				margin-top: 20px;
				border-bottom: 2px solid var(--primary-color);
				padding-bottom: 8px;
				display: inline-block;
			}

			h3 {
				margin-top: 20px;
				color: #34495e;
			}

			.docs-link {
				color: var(--primary-color);
				text-decoration: none;
				font-weight: bold;
				transition: all 0.2s ease;
			}

			.docs-link:hover {
				text-decoration: underline;
				color: var(--primary-dark);
			}

			.api-tester {
				background-color: var(--bg-white);
				border: 1px solid var(--border-color);
				border-radius: 10px;
				padding: 25px;
				margin-top: 20px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
			}

			.form-group {
				margin-bottom: 18px;
			}

			.date-range {
				display: flex;
				align-items: center;
				gap: 10px;
				flex-wrap: wrap;
			}

			.date-range input[type="date"] {
				flex: 1 1 160px;
				min-width: 140px;
			}

			.date-separator {
				color: #666;
				font-weight: 600;
			}

			.form-hint {
				margin-top: 6px;
				font-size: 12px;
				color: #777;
			}

			label {
				display: block;
				margin-bottom: 6px;
				font-weight: 600;
				color: #34495e;
			}

			input,
			select,
			textarea {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid #ddd;
				border-radius: 6px;
				box-sizing: border-box;
				font-size: 14px;
				transition: all 0.3s;
			}

			input:focus,
			select:focus,
			textarea:focus {
				outline: none;
				border-color: var(--primary-color);
				box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
			}

			input::placeholder,
			textarea::placeholder {
				color: #aaa;
			}

			button {
				background-color: var(--primary-color);
				color: white;
				border: none;
				padding: 12px 18px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 500;
				transition: all 0.3s;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}

			button:hover {
				background-color: var(--primary-dark);
				transform: translateY(-1px);
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}

			button:active {
				transform: translateY(0);
			}

			.result-container {
				margin-top: 20px;
				border: 1px solid var(--border-color);
				border-radius: 6px;
				padding: 15px;
				background-color: #f9f9f9;
				max-height: 400px;
				overflow-y: auto;
				white-space: pre-wrap;
				font-family: "SFMono-Regular", Consolas, "Liberation Mono",
					Menlo, monospace;
				font-size: 14px;
				line-height: 1.5;
				position: relative;
			}

			.result-block {
				margin: 0;
				white-space: pre-wrap;
				font-family: "SFMono-Regular", Consolas, "Liberation Mono",
					Menlo, monospace;
				font-size: 14px;
				line-height: 1.6;
			}

			.request-url {
				background-color: #f0f0f0;
				padding: 10px;
				border-radius: 6px;
				margin-bottom: 10px;
				font-family: "SFMono-Regular", Consolas, "Liberation Mono",
					Menlo, monospace;
				font-size: 14px;
				word-break: break-all;
				border: 1px dashed #ccc;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.url-text {
				flex-grow: 1;
				margin-right: 10px;
			}

			.copy-url-button {
				background-color: #9b59b6;
				padding: 6px 12px;
				font-size: 12px;
				white-space: nowrap;
			}

			.loading {
				text-align: center;
				padding: 20px;
				color: #666;
			}

			.loading::after {
				content: "...";
				animation: dots 1.5s steps(5, end) infinite;
			}

			@keyframes dots {
				0%,
				20% {
					content: ".";
				}
				40% {
					content: "..";
				}
				60% {
					content: "...";
				}
				80%,
				100% {
					content: "";
				}
			}

			.tab-container {
				display: flex;
				margin-bottom: 20px;
				border-bottom: 1px solid #e0e0e0;
			}

			.tab {
				padding: 12px 20px;
				cursor: pointer;
				margin-right: 5px;
				border-radius: 6px 6px 0 0;
				font-weight: 500;
				transition: all 0.2s;
				border: 1px solid transparent;
				border-bottom: none;
				position: relative;
				bottom: -1px;
			}

			.tab:hover {
				background-color: #f0f8ff;
			}

			.tab.active {
				background-color: var(--bg-white);
				border-color: #e0e0e0;
				color: var(--primary-color);
				border-bottom: 1px solid white;
			}

			.tab-content {
				display: none;
				padding: 20px 0;
			}

			.tab-content.active {
				display: block;
				animation: fadeIn 0.3s;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			.button-group {
				display: flex;
				justify-content: flex-end;
				margin-top: 20px;
			}

			.copy-button {
				background-color: var(--success-color);
				padding: 8px 15px;
				font-size: 14px;
				margin-left: 10px;
			}

			.copy-button:hover {
				background-color: var(--success-dark);
			}

			.error-message {
				color: var(--error-color);
				font-weight: bold;
				margin-top: 10px;
				padding: 10px;
				border-radius: 4px;
				background-color: rgba(231, 76, 60, 0.1);
				border-left: 4px solid var(--error-color);
				display: none;
			}

			.api-description {
				margin-bottom: 15px;
				color: #555;
			}

			.badge {
				display: inline-block;
				padding: 3px 8px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: 600;
				margin-left: 8px;
				background-color: rgba(52, 152, 219, 0.1);
				color: var(--primary-color);
			}

			.optional-param {
				font-size: 12px;
				color: #777;
				margin-left: 5px;
				font-style: italic;
			}

			.search-highlight {
				background-color: #fff3b0;
				color: inherit;
				padding: 0 2px;
				border-radius: 3px;
			}

			.required-field {
				color: var(--error-color);
				font-weight: bold;
			}

			.voice-message {
				display: inline-flex;
				flex-direction: column;
				gap: 6px;
				align-items: flex-start;
				background: rgba(46, 189, 240, 0.08);
				padding: 6px 8px;
				border-radius: 8px;
				margin: 4px 0;
			}

			.voice-message .voice-stt-btn {
				background-color: #2d333b;
				border: 1px solid #4d6277;
				color: #d7e2f2;
				font-size: 12px;
				padding: 4px 10px;
				border-radius: 4px;
				cursor: pointer;
				transition: background 0.2s ease, opacity 0.2s ease;
			}

			.voice-message .voice-stt-btn:hover {
				background-color: #3a4a5b;
			}

			.voice-message .voice-stt-btn[disabled] {
				opacity: 0.65;
				cursor: wait;
			}

			.voice-message .voice-transcript {
				font-size: 13px;
				color: #2c3e50;
				background: rgba(255, 255, 255, 0.7);
				padding: 6px 8px;
				border-radius: 6px;
				line-height: 1.6;
				white-space: pre-wrap;
				word-break: break-word;
				max-width: 600px;
			}

			.voice-message .voice-transcript[data-state="idle"] {
				display: none;
			}

			.voice-message .voice-text {
				white-space: pre-wrap;
				word-break: break-word;
			}

			.voice-message .voice-transcript .voice-segment {
				padding: 4px 0;
				border-left: 2px solid rgba(52, 152, 219, 0.45);
				margin-top: 4px;
				padding-left: 8px;
			}

			.voice-message .voice-transcript .voice-segment-time {
				font-size: 12px;
				color: #6c7a89;
			}

			.voice-message .voice-segments {
				display: flex;
				flex-direction: column;
				gap: 6px;
				margin-top: 8px;
			}

			.voice-message .voice-meta,
			.voice-message .voice-transcript .voice-meta {
				margin-top: 6px;
				font-size: 12px;
				color: #6c7a89;
			}

			.voice-message .voice-transcript .voice-segment span {
				display: block;
			}

			.voice-message .voice-text.voice-empty {
				color: #95a5a6;
				font-style: italic;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="welcome-text">
				<h1>ğŸ‰ æ­å–œï¼Chatlog æœåŠ¡å·²æˆåŠŸå¯åŠ¨</h1>
				<p>
					Chatlog
					æ˜¯ä¸€ä¸ªå¸®åŠ©ä½ è½»æ¾ä½¿ç”¨è‡ªå·±èŠå¤©æ•°æ®çš„å·¥å…·ï¼Œç°åœ¨ä½ å¯ä»¥é€šè¿‡ HTTP
					API è®¿é—®ä½ çš„èŠå¤©è®°å½•ã€è”ç³»äººå’Œç¾¤èŠä¿¡æ¯ã€‚
				</p>
			</div>

			<div class="api-section">
				<h2>ğŸ” API æ¥å£ä¸è°ƒè¯•</h2>

				<div class="api-tester">
					<div class="tab-container">
						<div class="tab active" data-tab="session">
							æœ€è¿‘ä¼šè¯
						</div>
						<div class="tab" data-tab="chatroom">ç¾¤èŠ</div>
						<div class="tab" data-tab="contact">è”ç³»äºº</div>
						<div class="tab" data-tab="chatlog">èŠå¤©è®°å½•</div>
						<div class="tab" data-tab="search">æœç´¢</div>
						<div class="tab" data-tab="diary">æ—¥è®°</div>
					</div>

					<!-- ä¼šè¯æŸ¥è¯¢è¡¨å• -->
					<div class="tab-content active" id="session-tab">
						<div class="api-description">
							<p>
								æŸ¥è¯¢æœ€è¿‘ä¼šè¯åˆ—è¡¨ã€‚<span class="badge"
									>GET /api/v1/session</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="session-format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="session-format">
								<option value="">é»˜è®¤</option>
								<option value="json">JSON</option>
								<option value="text">çº¯æ–‡æœ¬</option>
								<option value="html">HTML</option>
							</select>
						</div>
					</div>

					<!-- æ—¥è®°æŸ¥è¯¢è¡¨å• -->
					<div class="tab-content" id="diary-tab">
						<div class="api-description">
							<p>
								é€‰æ‹©æŸä¸€å¤©å¯¼å‡ºå½“æ—¥æˆ‘å‚ä¸è¿‡çš„ä¼šè¯å…¨éƒ¨æ¶ˆæ¯ã€‚<span
									class="badge"
									>GET /api/v1/diary</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="diary-date"
								>é€‰æ‹©æ—¥æœŸï¼š<span class="required-field"
									>*</span
								></label
							>
							<input type="date" id="diary-date" />
						</div>
						<div class="form-group">
							<label for="diary-talker"
								>èŠå¤©å¯¹è±¡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="diary-talker"
								placeholder="wxidã€ç¾¤IDã€å¤‡æ³¨åæˆ–æ˜µç§°ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰"
							/>
						</div>
						<div class="form-group">
							<label for="diary-format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="diary-format">
								<option value="">é»˜è®¤</option>
								<option value="json">JSON</option>
								<option value="text">çº¯æ–‡æœ¬</option>
								<option value="html">HTML</option>
								<option value="csv">CSV</option>
							</select>
						</div>
					</div>

					<!-- ç¾¤èŠæŸ¥è¯¢è¡¨å• -->
					<div class="tab-content" id="chatroom-tab">
						<div class="api-description">
							<p>
								æŸ¥è¯¢ç¾¤èŠåˆ—è¡¨ï¼Œå¯é€‰æ‹©æ€§åœ°æŒ‰å…³é”®è¯æœç´¢ã€‚<span
									class="badge"
									>GET /api/v1/chatroom</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="chatroom-keyword"
								>æœç´¢ç¾¤èŠï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="chatroom-keyword"
								placeholder="è¾“å…¥å…³é”®è¯æœç´¢ç¾¤èŠ"
							/>
						</div>
						<div class="form-group">
							<label for="chatroom-format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="chatroom-format">
								<option value="">é»˜è®¤</option>
								<option value="json">JSON</option>
								<option value="text">çº¯æ–‡æœ¬</option>
							</select>
						</div>
					</div>

					<!-- è”ç³»äººæŸ¥è¯¢è¡¨å• -->
					<div class="tab-content" id="contact-tab">
						<div class="api-description">
							<p>
								æŸ¥è¯¢è”ç³»äººåˆ—è¡¨ï¼Œå¯é€‰æ‹©æ€§åœ°æŒ‰å…³é”®è¯æœç´¢ã€‚<span
									class="badge"
									>GET /api/v1/contact</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="contact-keyword"
								>æœç´¢è”ç³»äººï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="contact-keyword"
								placeholder="è¾“å…¥å…³é”®è¯æœç´¢è”ç³»äºº"
							/>
						</div>
						<div class="form-group">
							<label for="contact-format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="contact-format">
								<option value="">é»˜è®¤</option>
								<option value="json">JSON</option>
								<option value="text">çº¯æ–‡æœ¬</option>
							</select>
						</div>
					</div>

					<!-- èŠå¤©è®°å½•æŸ¥è¯¢è¡¨å• -->
					<div class="tab-content" id="chatlog-tab">
						<div class="api-description">
							<p>
								æŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´å†…ä¸ç‰¹å®šè”ç³»äººæˆ–ç¾¤èŠçš„èŠå¤©è®°å½•ã€‚<span
									class="badge"
									>GET /api/v1/chatlog</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="start-date"
								>æ—¶é—´èŒƒå›´ï¼š<span class="required-field"
									>*</span
								></label
							>
							<div class="date-range">
								<input type="date" id="start-date" />
								<span class="date-separator">è‡³</span>
								<input type="date" id="end-date" />
							</div>
							<div class="form-hint">
								è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸï¼Œç»“æŸæ—¥æœŸå¯é€‰ï¼Œé»˜è®¤ä¸ºåŒä¸€å¤©
							</div>
						</div>
						<div class="form-group">
							<label for="talker"
								>èŠå¤©å¯¹è±¡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="talker"
								placeholder="wxidã€ç¾¤IDã€å¤‡æ³¨åæˆ–æ˜µç§° (ç•™ç©ºè¾“å‡ºæ‰€æœ‰)"
							/>
						</div>
						<div class="form-group">
							<label for="sender"
								>å‘é€è€…ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="sender"
								placeholder="æŒ‡å®šæ¶ˆæ¯å‘é€è€…"
							/>
						</div>
						<div class="form-group">
							<label for="keyword"
								>å…³é”®è¯ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="text"
								id="keyword"
								placeholder="æœç´¢æ¶ˆæ¯å†…å®¹ä¸­çš„å…³é”®è¯"
							/>
						</div>
						<div class="form-group">
							<label for="limit"
								>è¿”å›æ•°é‡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="number"
								id="limit"
								placeholder="é»˜è®¤ä¸åšé™åˆ¶"
							/>
						</div>
						<div class="form-group">
							<label for="offset"
								>åç§»é‡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								type="number"
								id="offset"
								placeholder="é»˜è®¤ 0"
							/>
						</div>
						<div class="form-group">
							<label for="format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="format">
								<option value="">é»˜è®¤</option>
								<option value="text">çº¯æ–‡æœ¬</option>
								<option value="json">JSON</option>
								<option value="csv">CSV</option>
								<option value="html">HTML</option>
							</select>
						</div>
					</div>

					<!-- æœç´¢è¡¨å• -->
					<div class="tab-content" id="search-tab">
						<div class="api-description">
							<p>
								ä½¿ç”¨
								<strong>Bleve</strong>
								åœ¨æŒ‡å®šä¼šè¯ä¸­æŸ¥æ‰¾æ¶ˆæ¯ã€‚<span class="badge"
									>GET /api/v1/search</span
								>
							</p>
						</div>
						<div class="form-group">
							<label for="search-query"
								>å…³é”®è¯ï¼š<span class="required-field"
									>*</span
								></label
							>
							<input
								id="search-query"
								type="text"
								placeholder="æ”¯æŒç©ºæ ¼åˆ†è¯"
							/>
						</div>
						<div class="form-group">
							<label for="search-talker"
								>èŠå¤©å¯¹è±¡ï¼ˆå¯å¤šä¸ªï¼Œè‹±æ–‡é€—å·åˆ†éš”ï¼‰ï¼š<span
									class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								id="search-talker"
								type="text"
								placeholder="wxidã€ç¾¤IDã€å¤‡æ³¨åæˆ–æ˜µç§° (ç•™ç©ºè¾“å‡ºæ‰€æœ‰)"
							/>
						</div>
						<div class="form-group">
							<label for="search-sender"
								>å‘é€è€…ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								id="search-sender"
								type="text"
								placeholder="æ”¯æŒå¤šä¸ªå‘é€è€…ï¼Œè‹±æ–‡é€—å·åˆ†éš”"
							/>
						</div>
						<div class="form-group">
							<label for="search-start-date"
								>æ—¶é—´èŒƒå›´ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<div class="date-range">
								<input type="date" id="search-start-date" />
								<span class="date-separator">è‡³</span>
								<input type="date" id="search-end-date" />
							</div>
							<div class="form-hint">
								ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶æ—¶é—´èŒƒå›´ã€‚
							</div>
						</div>
						<div class="form-group">
							<label for="search-limit"
								>è¿”å›æ•°é‡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								id="search-limit"
								type="number"
								min="1"
								max="200"
								placeholder="é»˜è®¤ 20ï¼Œæœ€å¤§ 200"
							/>
						</div>
						<div class="form-group">
							<label for="search-offset"
								>åç§»é‡ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<input
								id="search-offset"
								type="number"
								min="0"
								placeholder="é»˜è®¤ 0"
							/>
						</div>
						<div class="form-group">
							<label for="search-format"
								>è¾“å‡ºæ ¼å¼ï¼š<span class="optional-param"
									>å¯é€‰</span
								></label
							>
							<select id="search-format">
								<option value="">é»˜è®¤</option>
								<option value="json">JSON</option>
								<option value="text">çº¯æ–‡æœ¬</option>
								<option value="html">HTML</option>
								<option value="csv">CSV</option>
							</select>
						</div>
					</div>

					<button id="test-api">æ‰§è¡ŒæŸ¥è¯¢</button>

					<div
						id="result-wrapper"
						style="display: none; margin-top: 20px"
					>
						<div class="request-url" id="request-url-container">
							<span class="url-text" id="request-url"></span>
							<button
								class="copy-button copy-url-button"
								id="copy-url"
							>
								å¤åˆ¶è¯·æ±‚URL
							</button>
						</div>
						<div class="result-container" id="api-result">
							<p>æŸ¥è¯¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
						</div>
						<div class="button-group">
							<button class="copy-button" id="copy-result">
								å¤åˆ¶ç»“æœ
							</button>
						</div>
					</div>
					<div class="error-message" id="error-message"></div>
				</div>
			</div>

			<div class="api-section">
				<h2>ğŸ¤– MCP é›†æˆ</h2>
				<p>
					Chatlog æ”¯æŒ MCP (Model Context Protocol) SSE åè®®ï¼Œå¯ä¸æ”¯æŒ
					MCP çš„ AI åŠ©æ‰‹æ— ç¼é›†æˆã€‚
				</p>
				<p>SSE ç«¯ç‚¹ï¼š<strong>/sse</strong></p>
				<p>
					è¯¦ç»†é›†æˆæŒ‡å—è¯·å‚è€ƒ
					<a
						href="https://github.com/sjzar/chatlog/blob/main/docs/mcp.md"
						class="docs-link"
						target="_blank"
						>MCP é›†æˆæŒ‡å—</a
					>
				</p>
			</div>

			<div class="api-section">
				<h2>ğŸ“š æ›´å¤šèµ„æº</h2>
				<p>
					æŸ¥çœ‹
					<a
						href="https://github.com/sjzar/chatlog"
						class="docs-link"
						target="_blank"
						>GitHub é¡¹ç›®</a
					>
					è·å–å®Œæ•´æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—ã€‚
				</p>
				<p>
					å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿é€šè¿‡
					<a
						href="https://github.com/sjzar/chatlog/discussions"
						class="docs-link"
						target="_blank"
						>Discussions</a
					>
					è¿›è¡Œäº¤æµã€‚
				</p>
			</div>
		</div>

		<script>
			// æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
			document.querySelectorAll(".tab").forEach((tab) => {
				tab.addEventListener("click", function () {
					// ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
					document
						.querySelectorAll(".tab")
						.forEach((t) => t.classList.remove("active"));
					// è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
					this.classList.add("active");

					// éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
					document
						.querySelectorAll(".tab-content")
						.forEach((content) => {
							content.classList.remove("active");
						});

					// æ˜¾ç¤ºå½“å‰æ ‡ç­¾å¯¹åº”çš„å†…å®¹
					const tabId = this.getAttribute("data-tab") + "-tab";
					document.getElementById(tabId).classList.add("active");

					// æ¸…ç©ºç»“æœåŒºåŸŸ
					document.getElementById("result-wrapper").style.display =
						"none";
					document.getElementById("api-result").innerHTML =
						"<p>æŸ¥è¯¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>";
					document.getElementById("request-url").textContent = "";
					document.getElementById("error-message").style.display =
						"none";
					document.getElementById("error-message").textContent = "";
				});
			});

			// API æµ‹è¯•åŠŸèƒ½
			document
				.getElementById("test-api")
				.addEventListener("click", async function () {
					const resultContainer =
						document.getElementById("api-result");
					const requestUrlContainer =
						document.getElementById("request-url");
					const errorMessage =
						document.getElementById("error-message");
					const resultWrapper =
						document.getElementById("result-wrapper");

					errorMessage.style.display = "none";
					errorMessage.textContent = "";

					let highlightTerms = [];
					let responseFormat = "";

					try {
						const activeTab = document
							.querySelector(".tab.active")
							.getAttribute("data-tab");
						let url = "/api/v1/";
						const params = new URLSearchParams();

						switch (activeTab) {
							case "chatlog": {
								url += "chatlog";
								const startDate =
									document.getElementById("start-date").value;
								const endDate =
									document.getElementById("end-date").value;
								const talker = document
									.getElementById("talker")
									.value.trim();
								const sender = document
									.getElementById("sender")
									.value.trim();
								const keyword = document
									.getElementById("keyword")
									.value.trim();
								const limit =
									document.getElementById("limit").value;
								const offset =
									document.getElementById("offset").value;
								const format =
									document.getElementById("format").value;

								if (!startDate && !endDate) {
									errorMessage.textContent =
										"é”™è¯¯: è¯·è‡³å°‘é€‰æ‹©å¼€å§‹æ—¥æœŸï¼";
									errorMessage.style.display = "block";
									return;
								}

								if (!startDate && endDate) {
									errorMessage.textContent =
										"é”™è¯¯: è¯·å…ˆé€‰æ‹©å¼€å§‹æ—¥æœŸï¼";
									errorMessage.style.display = "block";
									return;
								}

								let timeValue = "";
								if (startDate && endDate) {
									if (
										new Date(startDate) > new Date(endDate)
									) {
										errorMessage.textContent =
											"é”™è¯¯: ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼";
										errorMessage.style.display = "block";
										return;
									}
									timeValue = `${startDate}~${endDate}`;
								} else if (startDate) {
									timeValue = startDate;
								}

								if (!timeValue) {
									errorMessage.textContent =
										"é”™è¯¯: æ—¶é—´èŒƒå›´ä¸åˆæ³•ï¼";
									errorMessage.style.display = "block";
									return;
								}

								params.append("time", timeValue);
								if (talker) params.append("talker", talker);
								if (sender) params.append("sender", sender);
								if (keyword) {
									params.append("keyword", keyword);
									highlightTerms =
										extractSearchTerms(keyword);
								}
								if (limit) params.append("limit", limit);
								if (offset) params.append("offset", offset);
								if (format) {
									params.append("format", format);
									responseFormat = format;
								}
								break;
							}
							case "contact": {
								url += "contact";
								const contactKeyword = document
									.getElementById("contact-keyword")
									.value.trim();
								const contactFormat =
									document.getElementById(
										"contact-format"
									).value;

								if (contactKeyword) {
									params.append("keyword", contactKeyword);
									highlightTerms =
										extractSearchTerms(contactKeyword);
								}
								if (contactFormat) {
									params.append("format", contactFormat);
									responseFormat = contactFormat;
								}
								break;
							}
							case "chatroom": {
								url += "chatroom";
								const chatroomKeyword = document
									.getElementById("chatroom-keyword")
									.value.trim();
								const chatroomFormat =
									document.getElementById(
										"chatroom-format"
									).value;

								if (chatroomKeyword) {
									params.append("keyword", chatroomKeyword);
									highlightTerms =
										extractSearchTerms(chatroomKeyword);
								}
								if (chatroomFormat) {
									params.append("format", chatroomFormat);
									responseFormat = chatroomFormat;
								}
								break;
							}
							case "session": {
								url += "session";
								const sessionFormat =
									document.getElementById(
										"session-format"
									).value;
								if (sessionFormat) {
									params.append("format", sessionFormat);
									responseFormat = sessionFormat;
								}
								break;
							}
							case "diary": {
								url += "diary";
								const diaryDateInput =
									document.getElementById("diary-date");
								const diaryDate = diaryDateInput
									? diaryDateInput.value
									: "";
								const diaryTalker = document
									.getElementById("diary-talker")
									.value.trim();
								const diaryFormat =
									document.getElementById(
										"diary-format"
									).value;

								if (!diaryDate) {
									errorMessage.textContent =
										"é”™è¯¯: è¯·é€‰æ‹©æ—¥æœŸï¼";
									errorMessage.style.display = "block";
									return;
								}

								params.append("date", diaryDate);
								if (diaryTalker) {
									params.append("talker", diaryTalker);
									highlightTerms =
										extractSearchTerms(diaryTalker);
								}
								if (diaryFormat) {
									params.append("format", diaryFormat);
									responseFormat = diaryFormat;
								}
								break;
							}
							case "search": {
								url += "search";
								const searchQuery =
									document.getElementById(
										"search-query"
									).value;
								const searchTalker =
									document.getElementById(
										"search-talker"
									).value;
								const searchSender =
									document.getElementById(
										"search-sender"
									).value;
								const searchStartDate =
									document.getElementById(
										"search-start-date"
									).value;
								const searchEndDate =
									document.getElementById(
										"search-end-date"
									).value;
								const searchLimit =
									document.getElementById(
										"search-limit"
									).value;
								const searchOffset =
									document.getElementById(
										"search-offset"
									).value;
								const searchFormatSelect =
									document.getElementById("search-format");
								const searchFormatValue = searchFormatSelect
									? searchFormatSelect.value
									: "";

								if (!searchQuery.trim()) {
									errorMessage.textContent =
										"é”™è¯¯: è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼";
									errorMessage.style.display = "block";
									return;
								}

								const trimmedQuery = searchQuery.trim();
								highlightTerms =
									extractSearchTerms(trimmedQuery);
								params.append("q", trimmedQuery);

								const trimmedTalker = searchTalker.trim();
								if (trimmedTalker) {
									params.append("talker", trimmedTalker);
								}

								let searchTimeValue = "";
								if (searchStartDate && searchEndDate) {
									if (
										new Date(searchStartDate) >
										new Date(searchEndDate)
									) {
										errorMessage.textContent =
											"é”™è¯¯: ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼";
										errorMessage.style.display = "block";
										return;
									}
									searchTimeValue = `${searchStartDate}~${searchEndDate}`;
								} else if (searchStartDate) {
									searchTimeValue = searchStartDate;
								} else if (!searchStartDate && searchEndDate) {
									errorMessage.textContent =
										"é”™è¯¯: è¯·å…ˆé€‰æ‹©å¼€å§‹æ—¥æœŸï¼";
									errorMessage.style.display = "block";
									return;
								}

								if (searchSender)
									params.append(
										"sender",
										searchSender.trim()
									);
								if (searchTimeValue)
									params.append("time", searchTimeValue);
								if (searchLimit)
									params.append("limit", searchLimit);
								if (searchOffset)
									params.append("offset", searchOffset);
								if (searchFormatValue) {
									params.append("format", searchFormatValue);
									responseFormat = searchFormatValue;
								}
								break;
							}
						}

						const apiUrl = params.toString()
							? `${url}?${params.toString()}`
							: url;
						const fullUrl = window.location.origin + apiUrl;
						requestUrlContainer.textContent = fullUrl;
						resultWrapper.style.display = "block";
						resultContainer.innerHTML =
							'<div class="loading">åŠ è½½ä¸­</div>';

						const response = await fetch(apiUrl);
						if (!response.ok) {
							throw new Error(
								`HTTP error! Status: ${response.status}`
							);
						}

						const contentType =
							response.headers.get("content-type") || "";
						if (contentType.includes("application/json")) {
							const data = await response.json();
							const text = JSON.stringify(data, null, 2);
							const highlighted = highlightPlainText(
								text,
								highlightTerms
							);
							resultContainer.innerHTML = `<pre class="result-block">${highlighted}</pre>`;
						} else {
							const textResult = await response.text();
							const expectsHtml =
								(responseFormat || "").toLowerCase() ===
									"html" || contentType.includes("text/html");
							if (expectsHtml) {
								resultContainer.innerHTML = textResult;
								highlightHtmlContent(
									resultContainer,
									highlightTerms
								);
							} else {
								const highlighted = highlightPlainText(
									textResult,
									highlightTerms
								);
								resultContainer.innerHTML = `<pre class="result-block">${highlighted}</pre>`;
							}
						}
						prepareVoiceMessages(resultContainer);
					} catch (error) {
						resultContainer.innerHTML = "";
						errorMessage.textContent = `æŸ¥è¯¢å‡ºé”™: ${error.message}`;
						errorMessage.style.display = "block";
						console.error("APIæŸ¥è¯¢å‡ºé”™:", error);
					}
				});

			function escapeHtml(str) {
				if (str == null) return "";
				return str
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;")
					.replace(/'/g, "&#39;");
			}

			function extractSearchTerms(raw) {
				if (!raw) return [];
				return Array.from(
					new Set(
						raw
							.split(/[\s,ï¼Œï¼›;ã€]+/)
							.map((term) => term.trim())
							.filter(Boolean)
					)
				);
			}

			function buildHighlightPattern(terms) {
				if (!terms || !terms.length) return "";
				const escaped = Array.from(
					new Set(
						terms
							.map((term) =>
								term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")
							)
							.filter(Boolean)
					)
				).sort((a, b) => b.length - a.length);
				if (!escaped.length) return "";
				return `(${escaped.join("|")})`;
			}

			function highlightPlainText(text, terms) {
				const pattern = buildHighlightPattern(terms);
				if (!pattern) {
					return escapeHtml(text);
				}
				const regex = new RegExp(pattern, "gi");
				let lastIndex = 0;
				let highlighted = "";
				text.replace(regex, (match, _group, offset) => {
					highlighted += escapeHtml(text.slice(lastIndex, offset));
					highlighted += `<mark class="search-highlight">${escapeHtml(
						match
					)}</mark>`;
					lastIndex = offset + match.length;
					return match;
				});
				highlighted += escapeHtml(text.slice(lastIndex));
				return highlighted;
			}

			function highlightHtmlContent(container, terms) {
				const pattern = buildHighlightPattern(terms);
				if (!pattern) return;
				const walker = document.createTreeWalker(
					container,
					NodeFilter.SHOW_TEXT,
					null,
					false
				);
				const nodes = [];
				while (walker.nextNode()) {
					const node = walker.currentNode;
					if (!node || !node.nodeValue || !node.nodeValue.trim())
						continue;
					nodes.push(node);
				}
				nodes.forEach((textNode) => {
					const text = textNode.nodeValue;
					const regex = new RegExp(pattern, "gi");
					if (!regex.test(text)) {
						return;
					}
					regex.lastIndex = 0;
					const fragment = document.createDocumentFragment();
					let lastIndex = 0;
					text.replace(regex, (match, _group, offset) => {
						if (offset > lastIndex) {
							fragment.appendChild(
								document.createTextNode(
									text.slice(lastIndex, offset)
								)
							);
						}
						const mark = document.createElement("mark");
						mark.className = "search-highlight";
						mark.textContent = match;
						fragment.appendChild(mark);
						lastIndex = offset + match.length;
						return match;
					});
					if (lastIndex < text.length) {
						fragment.appendChild(
							document.createTextNode(text.slice(lastIndex))
						);
					}
					textNode.parentNode.replaceChild(fragment, textNode);
				});
			}

			const voiceFallbackCache = new Map();

			function prepareVoiceMessages(root) {
				if (!root) return;
				if (
					window.ChatlogSpeech &&
					typeof window.ChatlogSpeech.refreshVoiceMessages ===
						"function"
				) {
					window.ChatlogSpeech.refreshVoiceMessages();
					return;
				}
				fallbackEnsureVoiceState(root);
			}

			function fallbackEnsureVoiceState(root) {
				root.querySelectorAll(".voice-message").forEach((container) => {
					const transcript =
						container.querySelector(".voice-transcript");
					if (transcript && !transcript.dataset.state) {
						transcript.dataset.state = "idle";
					}
					const btn = container.querySelector(".voice-stt-btn");
					if (btn && !btn.dataset.labelIdle) {
						btn.dataset.labelIdle = btn.textContent.trim();
					}
				});
			}

			function voiceKeyFromButton(btn) {
				const container = btn.closest(".voice-message");
				if (!container) return "";
				const link = container.querySelector(
					"a.voice-original, a[href]"
				);
				if (!link) return "";
				const href = link.getAttribute("href") || "";
				try {
					const url = new URL(href, window.location.href);
					return (
						url.searchParams.get("msgid") ||
						url.searchParams.get("id") ||
						url.pathname
					);
				} catch (_err) {
					return href;
				}
			}

			async function fallbackVoiceRequest(btn) {
				const container = btn.closest(".voice-message");
				const transcript =
					container?.querySelector(".voice-transcript");
				const key = voiceKeyFromButton(btn);
				if (!container || !transcript || !key) return;

				if (!transcript.dataset.state) {
					transcript.dataset.state = "idle";
				}

				const cached = voiceFallbackCache.get(key);
				if (cached) {
					transcript.innerHTML = renderTranscript(cached);
					transcript.dataset.state = "ready";
					btn.disabled = false;
					btn.dataset.state = "done";
					btn.textContent = "æŸ¥çœ‹æ–‡å­—";
					return;
				}

				const originalText =
					btn.dataset.labelIdle || btn.textContent || "è¯­éŸ³è½¬æ–‡å­—";
				btn.dataset.labelIdle = originalText;
				btn.disabled = true;
				btn.dataset.state = "loading";
				btn.textContent = "è½¬æ–‡å­—ä¸­â€¦";

				transcript.dataset.state = "loading";
				transcript.textContent = "è¯­éŸ³è¯†åˆ«è¿›è¡Œä¸­â€¦";

				try {
					const response = await fetch("/api/v1/voice/transcribe", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ key }),
					});
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}`);
					}
					const payload = await response.json();
					voiceFallbackCache.set(key, payload);
					transcript.innerHTML = renderTranscript(payload);
					transcript.dataset.state = "ready";
					btn.disabled = false;
					btn.textContent = "å·²è½¬æ–‡å­—";
					btn.dataset.state = "done";
				} catch (err) {
					console.error("è¯­éŸ³è¯†åˆ«å¤±è´¥:", err);
					transcript.dataset.state = "error";
					transcript.textContent = `è½¬æ–‡å­—å¤±è´¥: ${err.message}`;
					btn.textContent = "é‡è¯•è½¬æ–‡å­—";
					btn.dataset.state = "error";
				} finally {
					btn.disabled = false;
				}
			}

			function renderTranscript(data) {
				const pieces = [];
				const rawText =
					data && typeof data.text === "string"
						? data.text.trim()
						: "";
				if (rawText) {
					pieces.push(
						`<div class="voice-text">${escapeHtml(rawText)}</div>`
					);
				} else {
					pieces.push(
						'<div class="voice-text voice-empty">æœªè¯†åˆ«åˆ°æ–‡æœ¬</div>'
					);
				}

				const segments = Array.isArray(data && data.segments)
					? data.segments
					: [];
				if (segments.length) {
					const rendered = segments
						.map((segment) => {
							const start = formatSeconds(
								segment && segment.start
							);
							const end = formatSeconds(segment && segment.end);
							const caption =
								segment && segment.text
									? segment.text.trim()
									: "";
							return `<div class="voice-segment"><span class="voice-segment-time">${escapeHtml(
								start
							)} - ${escapeHtml(end)}</span><span>${escapeHtml(
								caption
							)}</span></div>`;
						})
						.join("");
					pieces.push(
						`<div class="voice-segments">${rendered}</div>`
					);
				}

				const meta = [];
				if (data && data.language) {
					meta.push(`è¯­è¨€: ${escapeHtml(String(data.language))}`);
				}
				if (
					data &&
					typeof data.duration === "number" &&
					isFinite(data.duration) &&
					data.duration > 0
				) {
					meta.push(
						`éŸ³é¢‘: ${escapeHtml(formatSeconds(data.duration))}`
					);
				}
				if (meta.length) {
					pieces.push(
						`<div class="voice-meta">${meta.join(" Â· ")}</div>`
					);
				}

				return pieces.join("");
			}

			function formatSeconds(value) {
				const num = Number(value);
				if (!isFinite(num) || num <= 0) {
					return "0s";
				}
				if (num >= 60) {
					const m = Math.floor(num / 60);
					const s = Math.round(num % 60);
					return `${m}m${s < 10 ? "0" : ""}${s}s`;
				}
				if (num < 1) {
					return `${num.toFixed(2)}s`;
				}
				return `${Math.round(num)}s`;
			}

			document.addEventListener("click", (event) => {
				const btn = event.target.closest(".voice-stt-btn");
				if (!btn) return;
				if (
					window.ChatlogSpeech &&
					typeof window.ChatlogSpeech.requestVoice === "function"
				) {
					return;
				}
				event.preventDefault();
				fallbackVoiceRequest(btn);
			});

			const diaryDateInput = document.getElementById("diary-date");
			if (diaryDateInput) {
				const today = new Date();
				const yyyy = today.getFullYear();
				const mm = String(today.getMonth() + 1).padStart(2, "0");
				const dd = String(today.getDate()).padStart(2, "0");
				const todayStr = `${yyyy}-${mm}-${dd}`;
				diaryDateInput.max = todayStr;
				if (!diaryDateInput.value) {
					diaryDateInput.value = todayStr;
				}
			}

			// å¤åˆ¶ç»“æœåŠŸèƒ½
			document
				.getElementById("copy-result")
				.addEventListener("click", function () {
					const resultText =
						document.getElementById("api-result").innerText;
					copyToClipboard(resultText, this, "å·²å¤åˆ¶ç»“æœ!");
				});

			// å¤åˆ¶URLåŠŸèƒ½
			document
				.getElementById("copy-url")
				.addEventListener("click", function () {
					// è·å–å®Œæ•´URLï¼ˆåŒ…å«åŸŸåéƒ¨åˆ†ï¼‰
					const urlText =
						document.getElementById("request-url").innerText;
					copyToClipboard(urlText, this, "å·²å¤åˆ¶URL!");
				});

			// é€šç”¨å¤åˆ¶åŠŸèƒ½ï¼ˆæ”¯æŒéå®‰å…¨ä¸Šä¸‹æ–‡çš„å›é€€æ–¹æ¡ˆï¼‰
			function copyToClipboard(text, button, successMessage) {
				const originalText = button.textContent;
				const toast = (msg) => {
					button.textContent = msg;
					setTimeout(() => {
						button.textContent = originalText;
					}, 2000);
				};

				// æ— å¯å¤åˆ¶å†…å®¹
				if (!text || text.trim() === "") {
					toast("æ— å¯å¤åˆ¶å†…å®¹");
					return;
				}

				// ç°ä»£ APIï¼Œè¦æ±‚å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆhttps æˆ– localhostï¼‰
				if (navigator.clipboard && window.isSecureContext) {
					navigator.clipboard
						.writeText(text)
						.then(() => {
							toast(successMessage);
						})
						.catch((err) => {
							// å¤±è´¥æ—¶å°è¯•å›é€€
							const ok = fallbackCopyTextToClipboard(text);
							toast(ok ? successMessage : "å¤åˆ¶å¤±è´¥");
							if (!ok) console.error("å¤åˆ¶å¤±è´¥:", err);
						});
					return;
				}

				// éå®‰å…¨ä¸Šä¸‹æ–‡æˆ–ä¸æ”¯æŒ navigator.clipboard æ—¶ï¼Œä½¿ç”¨å›é€€æ–¹æ¡ˆ
				const ok = fallbackCopyTextToClipboard(text);
				toast(ok ? successMessage : "å¤åˆ¶å¤±è´¥");
			}

			// å›é€€å¤åˆ¶æ–¹æ¡ˆï¼šåˆ›å»ºéšè— textareaï¼Œä½¿ç”¨ execCommand('copy')
			function fallbackCopyTextToClipboard(text) {
				try {
					const textarea = document.createElement("textarea");
					textarea.value = text;
					// é¿å…é¡µé¢æ»šåŠ¨æŠ–åŠ¨
					textarea.style.position = "fixed";
					textarea.style.top = "-9999px";
					textarea.style.left = "-9999px";
					textarea.setAttribute("readonly", "");
					document.body.appendChild(textarea);
					textarea.focus();
					textarea.select();
					const ok = document.execCommand("copy");
					document.body.removeChild(textarea);
					return ok;
				} catch (e) {
					console.error("å›é€€å¤åˆ¶å¤±è´¥:", e);
					return false;
				}
			}
		</script>
	</body>
</html>
